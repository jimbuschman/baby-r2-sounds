#include "IBusBM.h"
#include "SoftwareSerial.h"
#include "DFRobotDFPlayerMini.h"

IBusBM IBus;
DFRobotDFPlayerMini myDFPlayer;
bool pins[10] = {false,false,false,false,false,false,false,false,false,false};
int CurrentVol = 30; //I belive 30 is max
int Pin8 = 0;//this one has 3 pos, so to utilize that we are pulling it out on its own
int ChannelValue = 0;

int VolumnChannel = 4;
int ThreePosChannel = 8;

bool playRandomSounds = false;

SoftwareSerial mySoftwareSerial(10, 11); // RX, TX

void setup() {
 IBus.begin(Serial); 
 Serial.begin(115200);


Serial.println(F("DFRobot DFPlayer Mini Demo"));
  Serial.println(F("Initializing DFPlayer ... (May take 3~5 seconds)"));
  
  if (!myDFPlayer.begin(mySoftwareSerial)) {  //Use softwareSerial to communicate with mp3.
    Serial.println(F("Unable to begin:"));
    Serial.println(F("1.Please recheck the connection!"));
    Serial.println(F("2.Please insert the SD card!"));
    while(true){
      delay(0); // Code to compatible with ESP8266 watch dog.
    }
  }
  Serial.println(F("DFPlayer Mini online."));
  
  myDFPlayer.volume(CurrentVol);  //Set volume value. From 0 to 30
  myDFPlayer.play(1);  //Play the first mp3

}

void printDetail(uint8_t type, int value){
  switch (type) {
    case TimeOut:
      Serial.println(F("Time Out!"));
      break;
    case WrongStack:
      Serial.println(F("Stack Wrong!"));
      break;
    case DFPlayerCardInserted:
      Serial.println(F("Card Inserted!"));
      break;
    case DFPlayerCardRemoved:
      Serial.println(F("Card Removed!"));
      break;
    case DFPlayerCardOnline:
      Serial.println(F("Card Online!"));
      break;
    case DFPlayerUSBInserted:
      Serial.println("USB Inserted!");
      break;
    case DFPlayerUSBRemoved:
      Serial.println("USB Removed!");
      break;
    case DFPlayerPlayFinished:
      Serial.print(F("Number:"));
      Serial.print(value);
      Serial.println(F(" Play Finished!"));
      break;
    case DFPlayerError:
      Serial.print(F("DFPlayerError:"));
      switch (value) {
        case Busy:
          Serial.println(F("Card not found"));
          break;
        case Sleeping:
          Serial.println(F("Sleeping"));
          break;
        case SerialWrongStack:
          Serial.println(F("Get Wrong Stack"));
          break;
        case CheckSumNotMatch:
          Serial.println(F("Check Sum Not Match"));
          break;
        case FileIndexOut:
          Serial.println(F("File Index Out of Bound"));
          break;
        case FileMismatch:
          Serial.println(F("Cannot Find File"));
          break;
        case Advertise:
          Serial.println(F("In Advertise"));
          break;
        default:
          break;
      }
      break;
    default:
      break;
  }
}

bool ReadChannel(int c)
{
  ChannelValue = IBus.readChannel(c);
  //Serial.print(ChannelValue);
  //Serial.println();
  if (ChannelValue > 1990) {
    return true;
  }
   else {
    return false;
  }
}


//This will convert the controler range to the volume range. In this instance the volume is 0-30. 
int GetVolumn(int value)
{
  int max = 30, min = 0; //the volume max and  min.
  int oldRange = 2000 - 1000;
  int newRange = max - min;
  int newValue = ((value - 1000) * newRange / oldRange) + min;
 
  return newValue;
}

void loop() {

  static unsigned long timer = millis();
  
  if (millis() - timer > 15000) {
    timer = millis();
    if(playRandomSounds)
    {
      //myDFPlayer.next();  //Play next mp3 every 15 second.
      myDFPlayer.play(random(1, myDFPlayer.readFolderCounts())); //plays random file every 15 seconds. 
    }
  }
  
  if (myDFPlayer.available()) {
    printDetail(myDFPlayer.readType(), myDFPlayer.read()); //Print the detail message from DFPlayer to handle different errors and states.
  }
  //loop through all 10 channels.
  for(int i = 1; i <= 10; i++)
  {
    bool switchOn = ReadChannel(i);
    
    if(i == VolumnChannel)//this is my vol control
    {
      int vol = GetVolumn(ChannelValue);
      if(CurrentVol != vol)
      {
        CurrentVol = vol;
        Serial.print(ChannelValue);
        Serial.print(": Val : ");      
        Serial.println(vol);

        myDFPlayer.volume(CurrentVol);
      }
      
    }
    else if(i == ThreePosChannel)// 3 pos toggle
    {
      if (ChannelValue > 1990) {
        if(Pin8 != 1792) //Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
        {
          Pin8 = 1792;//Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
          Serial.print(i);
          Serial.print(": 3pos : ");
          Serial.println(Pin8);

           myDFPlayer.play(1);
        }
      }
      else if (ChannelValue == 1500) {
        if(Pin8 != 1280)//Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
        {
          Pin8 = 1280;//Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
          Serial.print(i);
          Serial.print(": 3pos : ");
          Serial.println(Pin8);

           myDFPlayer.play(1);
        }
      }
      else {
        Pin8 = 0;
      }
    }
    else 
    {
      if(switchOn)
      {
        if(pins[i] == false)
        {
          Serial.print(i);
          Serial.print(": Down : ");
          Serial.println(ChannelValue);
          pins[i] = true;

          switch (i) {
            case 5:
              myDFPlayer.play(1);
              break;
            case 6:
              myDFPlayer.play(1);
              break;   
            case 7:
              playRandomSounds = true;
              break;        
          }
        }
      }
      else
      {
        pins[i] = false;
      }
    }

  }
      delay(1000);
}
