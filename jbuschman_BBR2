#include <IBusBM.h>

IBusBM IBus;
bool pins[10] = {false,false,false,false,false,false,false,false,false,false};
int CurrentVol = 30; //I belive 30 is max
int Pin8 = 0;//this one has 3 pos, so to utilize that we are pulling it out on its own
int ChannelValue = 0;

int VolumnChannel = 4;
int ThreePosChannel = 8;

void setup() {
 IBus.begin(Serial); 
 Serial.begin(115200);
// pinMode(LEDPIN, OUTPUT);
Serial.print("Ready...");
Serial.println();
}


bool ReadChannel(int c)
{
  ChannelValue = IBus.readChannel(c);
  //Serial.print(ChannelValue);
  //Serial.println();
  if (ChannelValue > 1990) {
    return true;
  }
   else {
    return false;
  }
}


//This will convert the controler range to the volume range. In this instance the volume is 0-30. 
int GetVolumn(int value)
{
  int max = 30, min = 0; //the volume max and  min.
  int oldRange = 2000 - 1000;
  int newRange = max - min;
  int newValue = ((value - 1000) * newRange / oldRange) + min;
 
  return newValue;
}

void loop() {

  //loop through all 10 channels.
  for(int i = 1; i <= 10; i++)
  {
    bool switchOn = ReadChannel(i);
    
    if(i == VolumnChannel)//this is my vol control
    {
      int vol = GetVolumn(ChannelValue);
      if(CurrentVol != vol)
      {
        CurrentVol = vol;
        Serial.print(ChannelValue);
        Serial.print(": Val : ");      
        Serial.println(vol);
      }
      
    }
    else if(i == ThreePosChannel)// 3 pos toggle
    {
      if (ChannelValue > 1990) {
        if(Pin8 != 1792) //Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
        {
          Pin8 = 1792;//Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
          Serial.print(i);
          Serial.print(": 3pos : ");
          Serial.println(Pin8);
        }
      }
      else if (ChannelValue == 1500) {
        if(Pin8 != 1280)//Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
        {
          Pin8 = 1280;//Magic number here, not sure why I couldn't get this to work like the volumn. These values worked for me.
          Serial.print(i);
          Serial.print(": 3pos : ");
          Serial.println(Pin8);
        }
      }
      else {
        Pin8 = 0;
      }
    }
    else 
    {
      if(switchOn)
      {
        if(pins[i] == false)
        {
          Serial.print(i);
          Serial.print(": Down : ");
          Serial.println(ChannelValue);
          pins[i] = true;
        }
      }
      else
      {
        pins[i] = false;
      }
    }

  }
      delay(1000);
}
